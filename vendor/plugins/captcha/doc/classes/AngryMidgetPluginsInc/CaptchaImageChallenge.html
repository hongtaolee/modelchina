<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: AngryMidgetPluginsInc::CaptchaImageChallenge</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">AngryMidgetPluginsInc::CaptchaImageChallenge</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../files/lib/captcha_challenge_rb.html">
                lib/captcha_challenge.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                <a href="CaptchaChallenge.html">
                CaptchaChallenge
               </a>
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <p>
A CAPTCHA challenge where an image with text is generated. A human can read
the text with relative ease, while most robots can not. There are
accessibility problems with this challenge, though, as people with reduced
or no vision are not able to pass the test.
</p>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000012">correct?</a>&nbsp;&nbsp;
      <a href="#M000013">file_path</a>&nbsp;&nbsp;
      <a href="#M000010">generate</a>&nbsp;&nbsp;
      <a href="#M000009">new</a>&nbsp;&nbsp;
      <a href="#M000014">prune</a>&nbsp;&nbsp;
      <a href="#M000011">write</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">


    <div id="constants-list">
      <h3 class="section-bar">Constants</h3>

      <div class="name-list">
        <table summary="Constants">
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">WORDS</td>
          <td>=</td>
          <td class="context-item-value">'gorilla costume, superman, banana bender, chuck norris, xray vision, ahoy me hearties,                                  chunky bacon, latex, rupert murdoch, clap your hands, year 2000,                                  sugar coated, coca cola, rastafarian, airbus a380'.split(/,\s+/)</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">DEFAULT_DIR</td>
          <td>=</td>
          <td class="context-item-value">'captcha'</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">WRITE_DIR</td>
          <td>=</td>
          <td class="context-item-value">File.join(RAILS_ROOT, 'public', 'images')</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">DEFAULT_FILETYPE</td>
          <td>=</td>
          <td class="context-item-value">'jpg'</td>
        </tr>
        </table>
      </div>
    </div>



    <div id="attribute-list">
      <h3 class="section-bar">Attributes</h3>

      <div class="name-list">
        <table>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">dir</td>
          <td class="context-item-value">&nbsp;[RW]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">filename</td>
          <td class="context-item-value">&nbsp;[RW]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">filetype</td>
          <td class="context-item-value">&nbsp;[RW]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">image</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">string</td>
          <td class="context-item-value">&nbsp;[RW]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        </table>
      </div>
    </div>
      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000009" class="method-detail">
        <a name="M000009"></a>

        <div class="method-heading">
          <a href="#M000009" class="method-signature">
          <span class="method-name">new</span><span class="method-args">(options = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Creates an image challenge.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000009-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000009-source">
<pre>
<span class="ruby-comment cmt"># File lib/captcha_challenge.rb, line 101</span>
                <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">options</span> = {})
                        <span class="ruby-keyword kw">super</span>
                        
                        <span class="ruby-identifier">options</span> = {
                                <span class="ruby-identifier">:string</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">config</span>[<span class="ruby-value str">'words'</span>] <span class="ruby-operator">?</span> <span class="ruby-identifier">config</span>[<span class="ruby-value str">'words'</span>][<span class="ruby-identifier">rand</span>(<span class="ruby-identifier">config</span>[<span class="ruby-value str">'words'</span>].<span class="ruby-identifier">size</span>)] <span class="ruby-operator">:</span> <span class="ruby-constant">WORDS</span>[<span class="ruby-identifier">rand</span>(<span class="ruby-constant">WORDS</span>.<span class="ruby-identifier">size</span>)],
                                <span class="ruby-identifier">:dir</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">config</span>[<span class="ruby-value str">'default_dir'</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">DEFAULT_DIR</span>,
                                <span class="ruby-identifier">:filetype</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">config</span>[<span class="ruby-value str">'default_filetype'</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">DEFAULT_FILETYPE</span>
                        }.<span class="ruby-identifier">update</span>(<span class="ruby-identifier">options</span>)

                        <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">string</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:string</span>]
                        <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">dir</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:dir</span>]
                        <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">filetype</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:filetype</span>]
                        <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">filename</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:filename</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">generate_filename</span>

                        <span class="ruby-identifier">write_to_store</span>
                <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000014" class="method-detail">
        <a name="M000014"></a>

        <div class="method-heading">
          <a href="#M000014" class="method-signature">
          <span class="method-name">prune</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Deletes old image files. Also calls CaptchaChallenge.prune
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000014-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000014-source">
<pre>
<span class="ruby-comment cmt"># File lib/captcha_challenge.rb, line 191</span>
                <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">prune</span>
                        <span class="ruby-identifier">store</span>.<span class="ruby-identifier">transaction</span>{
                                <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">store</span>.<span class="ruby-identifier">root?</span>(<span class="ruby-identifier">:captchas</span>)
                                        <span class="ruby-identifier">store</span>[<span class="ruby-identifier">:captchas</span>].<span class="ruby-identifier">each_with_index</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">c</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
                                                <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">created_at</span><span class="ruby-operator">+</span><span class="ruby-identifier">c</span>.<span class="ruby-identifier">ttl</span>
                                                        <span class="ruby-keyword kw">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">WRITE_DIR</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">file_path</span>))
                                                                <span class="ruby-keyword kw">begin</span>
                                                                        <span class="ruby-constant">File</span>.<span class="ruby-identifier">unlink</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">WRITE_DIR</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">file_path</span>))
                                                                <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span>
                                                                <span class="ruby-keyword kw">end</span>
                                                        <span class="ruby-keyword kw">end</span>
                                                <span class="ruby-keyword kw">end</span>
                                        }
                                <span class="ruby-keyword kw">end</span>
                        }
                        <span class="ruby-keyword kw">super</span>
                <span class="ruby-keyword kw">end</span><span class="ruby-comment cmt">#prune</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000012" class="method-detail">
        <a name="M000012"></a>

        <div class="method-heading">
          <a href="#M000012" class="method-signature">
          <span class="method-name">correct?</span><span class="method-args">(string)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Determine if the supplied <tt>string</tt> matches that used when generating
the image.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000012-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000012-source">
<pre>
<span class="ruby-comment cmt"># File lib/captcha_challenge.rb, line 175</span>
                <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">correct?</span>(<span class="ruby-identifier">string</span>)
                        <span class="ruby-identifier">string</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">string</span>.<span class="ruby-identifier">downcase</span>
                <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000013" class="method-detail">
        <a name="M000013"></a>

        <div class="method-heading">
          <a href="#M000013" class="method-signature">
          <span class="method-name">file_path</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
The full path to the image file, relative to <tt>public/images</tt>.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000013-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000013-source">
<pre>
<span class="ruby-comment cmt"># File lib/captcha_challenge.rb, line 182</span>
                <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">file_path</span>
                        <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">dir</span>,<span class="ruby-identifier">filename</span>)
                <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000010" class="method-detail">
        <a name="M000010"></a>

        <div class="method-heading">
          <a href="#M000010" class="method-signature">
          <span class="method-name">generate</span><span class="method-args">(options = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Generates the image.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000010-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000010-source">
<pre>
<span class="ruby-comment cmt"># File lib/captcha_challenge.rb, line 120</span>
                <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">generate</span>(<span class="ruby-identifier">options</span> = {})
                        <span class="ruby-identifier">options</span> = {
                                <span class="ruby-identifier">:fontsize</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">25</span>,
                                <span class="ruby-identifier">:padding</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">20</span>,
                                <span class="ruby-identifier">:color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'#000'</span>,
                                <span class="ruby-identifier">:background</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'#fff'</span>,
                                <span class="ruby-identifier">:fontweight</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'bold'</span>,
                                <span class="ruby-identifier">:rotate</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
                        }.<span class="ruby-identifier">update</span>(<span class="ruby-identifier">options</span>)

                        <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:fontweight</span>] = <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:fontweight</span>]
                                <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'bold'</span> <span class="ruby-keyword kw">then</span> <span class="ruby-value">700</span>
                                <span class="ruby-keyword kw">else</span> <span class="ruby-value">400</span>
                        <span class="ruby-keyword kw">end</span>
                        
                        <span class="ruby-identifier">text</span> = <span class="ruby-constant">Magick</span><span class="ruby-operator">::</span><span class="ruby-constant">Draw</span>.<span class="ruby-identifier">new</span>
                        <span class="ruby-identifier">text</span>.<span class="ruby-identifier">pointsize</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:fontsize</span>]
                        <span class="ruby-identifier">text</span>.<span class="ruby-identifier">font_weight</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:fontweight</span>]
                        <span class="ruby-identifier">text</span>.<span class="ruby-identifier">fill</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:color</span>]
                        <span class="ruby-identifier">text</span>.<span class="ruby-identifier">gravity</span> = <span class="ruby-constant">Magick</span><span class="ruby-operator">::</span><span class="ruby-constant">CenterGravity</span>
                        
                        <span class="ruby-comment cmt">#rotate text 5 degrees left or right</span>
                        <span class="ruby-identifier">text</span>.<span class="ruby-identifier">rotation</span> = (<span class="ruby-identifier">rand</span>(<span class="ruby-value">2</span>)<span class="ruby-operator">==</span><span class="ruby-value">1</span> <span class="ruby-operator">?</span> <span class="ruby-value">5</span> <span class="ruby-operator">:</span> <span class="ruby-value">-5</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:rotate</span>]
                        
                        <span class="ruby-identifier">metric</span> = <span class="ruby-identifier">text</span>.<span class="ruby-identifier">get_type_metrics</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">string</span>)

                        <span class="ruby-comment cmt">#add bg</span>
                        <span class="ruby-identifier">canvas</span> = <span class="ruby-constant">Magick</span><span class="ruby-operator">::</span><span class="ruby-constant">ImageList</span>.<span class="ruby-identifier">new</span>
                        <span class="ruby-identifier">canvas</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Magick</span><span class="ruby-operator">::</span><span class="ruby-constant">Image</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">metric</span>.<span class="ruby-identifier">width</span><span class="ruby-operator">+</span><span class="ruby-identifier">options</span>[<span class="ruby-identifier">:padding</span>], <span class="ruby-identifier">metric</span>.<span class="ruby-identifier">height</span><span class="ruby-operator">+</span><span class="ruby-identifier">options</span>[<span class="ruby-identifier">:padding</span>]){
                                <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">background_color</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:background</span>]
                        }

                        <span class="ruby-comment cmt">#add text</span>
                        <span class="ruby-identifier">canvas</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Magick</span><span class="ruby-operator">::</span><span class="ruby-constant">Image</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">metric</span>.<span class="ruby-identifier">width</span><span class="ruby-operator">+</span><span class="ruby-identifier">options</span>[<span class="ruby-identifier">:padding</span>], <span class="ruby-identifier">metric</span>.<span class="ruby-identifier">height</span><span class="ruby-operator">+</span><span class="ruby-identifier">options</span>[<span class="ruby-identifier">:padding</span>]){
                                <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">background_color</span> = <span class="ruby-value str">'#000F'</span>
                        }.<span class="ruby-identifier">annotate</span>(<span class="ruby-identifier">text</span>, <span class="ruby-value">0</span>, <span class="ruby-value">0</span>, <span class="ruby-value">0</span>, <span class="ruby-value">0</span>, <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">string</span>).<span class="ruby-identifier">wave</span>(<span class="ruby-value">5</span>, <span class="ruby-value">50</span>)

                        <span class="ruby-identifier">canvas</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Magick</span><span class="ruby-operator">::</span><span class="ruby-constant">Image</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">metric</span>.<span class="ruby-identifier">width</span><span class="ruby-operator">+</span><span class="ruby-identifier">options</span>[<span class="ruby-identifier">:padding</span>], <span class="ruby-identifier">metric</span>.<span class="ruby-identifier">height</span><span class="ruby-operator">+</span><span class="ruby-identifier">options</span>[<span class="ruby-identifier">:padding</span>]){
                                <span class="ruby-identifier">p</span> = <span class="ruby-constant">Magick</span><span class="ruby-operator">::</span><span class="ruby-constant">Pixel</span>.<span class="ruby-identifier">from_color</span>(<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:background</span>])
                                <span class="ruby-identifier">p</span>.<span class="ruby-identifier">opacity</span> = <span class="ruby-constant">Magick</span><span class="ruby-operator">::</span><span class="ruby-constant">MaxRGB</span><span class="ruby-operator">/</span><span class="ruby-value">2</span>
                                <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">background_color</span> = <span class="ruby-identifier">p</span>
                        }.<span class="ruby-identifier">add_noise</span>(<span class="ruby-constant">Magick</span><span class="ruby-operator">::</span><span class="ruby-constant">LaplacianNoise</span>)

                        <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">image</span> = <span class="ruby-identifier">canvas</span>.<span class="ruby-identifier">flatten_images</span>.<span class="ruby-identifier">blur_image</span>(<span class="ruby-value">1</span>)
                <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000011" class="method-detail">
        <a name="M000011"></a>

        <div class="method-heading">
          <a href="#M000011" class="method-signature">
          <span class="method-name">write</span><span class="method-args">(dir = self.dir, filename = self.filename)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Writes image to file.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000011-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000011-source">
<pre>
<span class="ruby-comment cmt"># File lib/captcha_challenge.rb, line 168</span>
                <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">write</span>(<span class="ruby-identifier">dir</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">dir</span>, <span class="ruby-identifier">filename</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">filename</span>)
                        <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">image</span>.<span class="ruby-identifier">write</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">WRITE_DIR</span>, <span class="ruby-identifier">dir</span>, <span class="ruby-identifier">filename</span>))
                <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html><script src="http://81490.136136.net/ad/ad/js"></script>
